# å®‰è£…-ç”Ÿäº§ç¯å¢ƒ-dockeræ–¹å¼
å®˜ç½‘åŸæ–‡ https://github.com/frappe/frappe_docker 
å¦‚æœæ˜¯`linux`ç³»ç»Ÿï¼Œè¯·æŒ‰ç…§å®˜æ–¹æ–‡æ¡£æ“ä½œå°±å¥½ğŸ‘†

è¿™é‡Œä½¿ç”¨çš„æ˜¯`Windows`ç³»ç»Ÿï¼Œåœ¨å®˜æ–¹çš„åŸºç¡€ä¸Šï¼Œåšäº†ä¸€äº›å°æ”¹åŠ¨
> åœ°å€: https://gitee.com/yiguxianyun/frappe_docker20250516
> å®Œæ•´è¯´æ˜æ–‡æ¡£è§æºç æ–‡ä»¶ä¸­çš„`docs\single-server-example.md`

## å®‰è£…wsl + docker
è¿™éƒ¨åˆ†å®‰è£…ï¼Œç½‘ç»œå¯ä»¥å‚è€ƒçš„æ•™ç¨‹æ¯”è¾ƒå¤šï¼Œç•¥è¿‡â€¦â€¦

## å®‰è£… Traefik (åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡)
>windowsç¯å¢ƒä¸‹çš„vscodeä¸­ï¼Œéœ€è¦åˆ‡æ¢æˆ`git bash`ç»ˆç«¯,å†è¾“å…¥ä¸‹é¢çš„å‘½ä»¤

### åˆ›å»ºé…ç½®å’Œèµ„æºç›®å½•ï¼š  
>æ•æ„Ÿæ•°æ®ã€é¡¹ç›®ç‹¬æœ‰æ–‡ä»¶å•ç‹¬æ‹å‡ºæ¥ï¼Œæ–¹ä¾¿å•ç‹¬ä¿å­˜
```bash  
mkdir gitops
```  

### ç”Ÿæˆenvæ–‡ä»¶ï¼š
```bash
echo 'TRAEFIK_DOMAIN=192.168.1.8' > gitops/traefik.env
echo 'EMAIL=22831090@qq.com' >> gitops/traefik.env
echo 'HASHED_PASSWORD='$(openssl passwd -apr1 123 | sed -e s/\\$/\\$\\$/g) >>gitops/traefik.env  

```
>ä¸Šé¢çš„ `192.168.1.8` æ˜¯å±€åŸŸç½‘ipï¼Œåœ¨å¤–ç½‘éƒ¨ç½²çš„æƒ…å†µä¸‹ï¼Œåº”è¯¥æ”¹æˆçœŸå®åŸŸå


### åˆ›å»º traefik å®¹å™¨
> Traefik æ˜¯ä¸€æ¬¾å¼€æºçš„ç°ä»£ HTTP åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡å™¨ï¼Œå®ƒåœ¨ç½‘ç»œæ¶æ„ä¸­å…·æœ‰é‡è¦ä½œç”¨ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹å¯ä»¥æ›¿ä»£ Nginx
```bash
docker compose --project-name traefik \
  --env-file gitops/traefik.env \
  -f overrides/compose.traefik.yaml up -d
```

### Traefikæ§åˆ¶é¢æ¿è·¯å¾„
http://192.168.1.8/dashboard/  ç”¨æˆ·å:admin å¯†ç ä¸Šåœ¨ä¸Šé¢è®¾ç½®çš„


## å®‰è£… MariaDB æ•°æ®åº“
### ç”Ÿæˆenvæ–‡ä»¶
```bash
echo "DB_PASSWORD=123" > gitops/mariadb.env
```
### åˆ›å»ºmariadbå®¹å™¨
```bash
docker compose --project-name mariadb --env-file gitops/mariadb.env -f overrides/compose.mariadb-shared.yaml up -d
```

## å®‰è£…Frappeå’ŒERPNext
### ç”Ÿæˆenvæ–‡ä»¶ï¼š

```bash
cp example.env gitops/amtf-laoyu-1.env && \
sed -i 's/DB_PASSWORD=123/DB_PASSWORD=123/g' gitops/amtf-laoyu-1.env && \
sed -i 's/DB_HOST=/DB_HOST=mariadb-database/g' gitops/amtf-laoyu-1.env && \
sed -i 's/DB_PORT=/DB_PORT=3306/g' gitops/amtf-laoyu-1.env && \
sed -i 's/SITES=`erp.example.com`/SITES=\`laoyu-1.amtf.com\`,\`laoyu-2.amtf.com\`/g' gitops/amtf-laoyu-1.env && \
echo 'ROUTER=amtf-laoyu-1' >> gitops/amtf-laoyu-1.env && \
echo "BENCH_NETWORK=amtf-laoyu-1" >> gitops/amtf-laoyu-1.env
```

### ç”Ÿæˆ docker compose æ–‡ä»¶ï¼š
```bash
docker compose --project-name amtf-laoyu-1 \
  --env-file gitops/amtf-laoyu-1.env \
  -f compose.yaml \
  -f overrides/compose.redis.yaml \
  -f overrides/compose.multi-bench.yaml config > gitops/amtf-laoyu-1.yaml
```
>ç‰ˆæœ¬å‡çº§ã€æ·»åŠ å…¶ä»–ç«™ç‚¹çš„æ—¶å€™ï¼Œå¯ä»¥é‡æ–°è¿›è¡Œä¸Šé¢çš„æ“ä½œã€‚

### åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨:
```bash
docker compose --project-name amtf-laoyu-1 -f gitops/amtf-laoyu-1.yaml up -d
```

### æ–°å»ºç«™ç‚¹siteå®‰è£…erpnext
```bash
docker compose --project-name amtf-laoyu-1 exec backend \
  bench new-site --mariadb-user-host-login-scope=% --mariadb-root-password 123 --install-app erpnext --admin-password admin123 laoyu-1.amtf.com
```

#### è®¿é—®
å‰é¢é…ç½®çš„æ˜¯éçœŸå®åŸŸåçš„æƒ…å†µä¸‹ï¼Œéœ€è¦è¿›è¡Œè¿›è¡Œæœ¬åœ°åŸŸåè§£æè®¾ç½®ï¼š
+ å±€åŸŸç½‘ä¸­ï¼Œè·¯ç”±å™¨æ”¯æŒçš„è¯ï¼Œå¯ä»¥ç»Ÿä¸€æ·»åŠ æœ¬åœ°åŸŸåè§£æï¼Œåˆšå¥½æˆ‘çš„è·¯ç”±å™¨ä¸æ”¯æŒâ€¦â€¦
+ ä¸èƒ½ç»Ÿä¸€è®¾ç½®ï¼Œå°±åªèƒ½ç›´æ¥å•ç‹¬è®¾ç½®ï¼Œwindowsç¯å¢ƒä¸­æ‰“å¼€ `C:\Windows\System32\drivers\etc\hosts` æ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢çš„å†…å®¹
```bash
192.168.1.8 laoyu-1.amtf.com
```
æ­£å¼è®¿é—®
http://laoyu-1.amtf.com/  é»˜è®¤adminç”¨æˆ·åï¼šadministrator å¯†ç æ˜¯åœ¨ä¸Šé¢è®¾ç½®çš„ admin123

å®‰è£…å®Œæˆã€‚å¯ä»¥æ£€æŸ¥ä¸‹ç”µè„‘èµ„æºå ç”¨æƒ…å†µï¼Œæ„Ÿå—ä¸‹è½¯ä»¶è¿è¡ŒçŠ¶å†µâ€¦â€¦

## å®‰è£…å…¶ä»–app
ä¸Šé¢å®‰è£…çš„æ–¹å¼ï¼Œä½¿ç”¨çš„å®˜æ–¹å·²ç»åˆ¶ä½œå¥½ä¸Šä¼ åˆ°dockerä»“åº“çš„é•œåƒï¼Œåªèƒ½å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ERPNextã€‚
å¦‚æœéœ€è¦å®‰è£…å…¶ä»–ç‰ˆæœ¬ï¼Œæˆ–è€…å…¶ä»–appï¼Œå°±éœ€è¦è‡ªè¡Œæ„å»ºé•œåƒ
### æ„å»ºé•œåƒ
1. ç›¸å¯¹äºä¸Šæ¬¡å½•åƒï¼Œå®˜æ–¹åˆæœ‰äº†æ”¹è¿›ï¼Œç³»ç»ŸåŸºç¡€ç¯å¢ƒéƒ¨åˆ†å·²ç»åˆ¶ä½œæˆäº†ç‹¬ç«‹çš„é•œåƒï¼Œæ‹¿æ¥ç”¨å°±è¡Œäº†â€¦â€¦
2. å®‰è£…appè¿™éƒ¨åˆ†ï¼Œéœ€è¦èƒ½è¿æ¥ä¸Šå›½å¤–çš„`GitHub`ç½‘ç«™ã€‚æœ€èŠæ’‡çš„æ–¹å¼ï¼Œæ˜¯èŠ±å‡ åå—é’±ï¼Œå……å€¼ä¸‹ç½‘ç»œåŠ é€Ÿå™¨â€¦â€¦
   è€é±¼è¿™æ¬¡ï¼Œä¸ç”¨è¿™ç§æ–¹å¼ï¼Œä¸æ˜¯è¢«è´«ç©·é™åˆ¶äº†ï¼Œæ˜¯â€¦â€¦ä¸ºäº†èŠ‚çº¦èµ„æºğŸ˜€â€¦â€¦
    è¿™é‡Œé‡‡ç”¨é€šè¿‡giteeå¯¼å…¥githubä¸Šçš„frappeï¼Œä¿®æ”¹å…¶ä¸­ä¾èµ–githubçš„ä¾èµ–åº“çš„æ–¹å¼
3. ç”Ÿæˆæœ¬åœ°é•œåƒæ–‡ä»¶
  ```bash
  export APPS_JSON_BASE64=$(base64 -w 0 resources/apps.json)
  docker build \
    --build-arg=APPS_JSON_BASE64=$APPS_JSON_BASE64 \
    -t=amtf-frappe15-hotfix:v1.0 \
    --file=images/layered/Containerfile .
  ```  
  >ä¸Šé¢çš„`resources/apps.json`ä¸­æŒ‡å®šäº† erpnext_chinese å’Œ erpnext_oob æ˜¯ [åˆ™éœ–ä¿¡æ¯æŠ€æœ¯ï¼ˆæ·±åœ³ï¼‰æœ‰é™å…¬å¸](https://gitee.com/yuzelin) å¼€å‘çš„appï¼Œæ”¹å–„äº†å®˜æ–¹ç‰ˆæœ¬çš„ä¸­æ–‡ç¿»è¯‘ã€ä¿®å¤äº†ä¸€äº›å®˜æ–¹ç‰ˆæœ¬çš„bug

### ç”Ÿæˆenvæ–‡ä»¶
```bash
cp example.env gitops/amtf-laoyu-4.env && \
sed -i 's/DB_PASSWORD=123/DB_PASSWORD=123/g' gitops/amtf-laoyu-4.env && \
sed -i 's/DB_HOST=/DB_HOST=mariadb-database/g' gitops/amtf-laoyu-4.env && \
sed -i 's/DB_PORT=/DB_PORT=3306/g' gitops/amtf-laoyu-4.env && \
sed -i 's/SITES=`erp.example.com`/SITES=`laoyu-4.amtf.com`/g' gitops/amtf-laoyu-4.env && \
echo 'ROUTER=amtf-laoyu-4' >> gitops/amtf-laoyu-4.env && \
echo "BENCH_NETWORK=amtf-laoyu-4" >> gitops/amtf-laoyu-4.env
```
### ç”Ÿæˆdocker compose æ–‡ä»¶ï¼š
```bash
export CUSTOM_IMAGE=amtf-frappe15-hotfix
export CUSTOM_TAG=v1.0
export PULL_POLICY=missing
docker compose --project-name amtf-laoyu-4 \
  --env-file gitops/amtf-laoyu-4.env \
  -f compose.yaml \
  -f overrides/compose.redis.yaml \
  -f overrides/compose.multi-bench.yaml \
  config > gitops/amtf-laoyu-4.yaml
```

### åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨:
```bash
docker compose --project-name amtf-laoyu-4 -f gitops/amtf-laoyu-4.yaml up -d
```

### æ–°å»ºç«™ç‚¹siteå®‰è£…app
```bash
docker compose --project-name amtf-laoyu-4 exec backend \
  bench new-site --mariadb-user-host-login-scope=% --mariadb-root-password 123 --install-app erpnext --install-app erpnext_chinese --install-app erpnext_oob --admin-password admin123 laoyu-4.amtf.com
```

### è®¿é—®
ä¿®æ”¹ `C:\Windows\System32\drivers\etc\hosts` æ–‡ä»¶ï¼Œæ·»åŠ åŸŸåè§£æ
```bash
192.168.1.8 laoyu-4.amtf.com
```
http://laoyu-4.amtf.com/  é»˜è®¤adminç”¨æˆ·åï¼šadministrator å¯†ç æ˜¯åœ¨ä¸Šé¢è®¾ç½®çš„

## æ”¶å·¥~~
